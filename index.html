<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapv1</title>

    <!-- leaflet css  -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
 
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            height: inherit; 
            width: 70%;
        }

        .coordinate {
            position: relative;
            bottom: 10px;
            right: 50%;
        }

        .leaflet-popup-content-wrapper {
            background-color: #f6fad1;
            color: #000000;
            border: 1px solid rgb(252, 255, 74);
            border-radius: 5px;
        }

        #maplist {
            overflow-y: auto; 
            width: 100%;
            height: 100%;  
            list-style: none; 
        }

        .container {
            position: relative;
            height: 100vh;
            width: 1200px;
        }

        .list_container {
            position: relative;
            margin-left: 70%;
            height: 100%;
            width: 30%;
        }

        #searchInput {
            width: 96%; 
        }

        .list_text {
            display: inline-block;
            white-space: nowrap;
            overflow:hidden;
        }

        .list_image {
            height: 84px;
            display: inline-block;
            vertical-align: top;
        }
        .popup_image {
            height: 100px;
            display: inline-block;
            vertical-align: top;
        }

       
    </style>
</head>

<body>
    <div class="container">
        
        <div id="map">
            <div class="leaflet-control coordinate"></div>
        </div>
        <div class = "list_container">
            <input type="text" id="searchInput" placeholder="Search by First or Last name...">
            <div id ="maplist">
            </div>
        </div>
    </div>
</body>

</html>

<!-- leaflet js  -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="PapaParse.js"></script>


<script>
    //create the map and its coordinates
    var map = L.map('map').setView([42.982521, -117.054526], 18);
    //map.setMaxBounds(map.getBounds());//this makes the total map bounds just what the initial image was, easy solution and I am lazy.
    
    ///////////////////////////////////////////
        //Commented out max bounds for ambrose bugfixing
    //////////////////

    let markersLayer = new L.LayerGroup().addTo(map);
    const listItems = document.getElementById('maplist');

    function addMarkers(data) {
        var myIcon = L.icon({
            iconUrl: 'icon.png',
            iconSize: [10, 10],
        });

        var textlist = [];
        var coorlist = [];
        var markerlist = [];
        var searchlist = [];

        //Creating the strings for the markers and lists
        for (let i = 0; i < data.length; i++) {
            filepath = "images/" + data[i]['Marker Photo'];
            popuptext = '<img src="' + filepath + '" alt="Image" class="popup_image">';
            if (data[i]['Marker Photo_Military'] != ''){
                popuptext += '<img src="' + 'images/' + data[i]['Marker Photo_Military'] + '" alt="Image" class="popup_image">';
            }
            popuptext += '<br>';
            popuptext += data[i]['Last Name'] + ', ' + data[i]['First Name'] + '<br>';
            if (data[i]['Maiden Name'] != ''){
                popuptext += 'Maiden Name: ' + data[i]['Maiden Name'] + '<br>';
            }
            popuptext += data[i]['Date of Birth'] +', '+data[i]['Date of Death'];
            textlist.push(popuptext);
            coorlist.push([data[i]['GPS 1'], data[i]['GPS 2']]);

            searchtext = '<img src="' + filepath + '" alt="Image" class="list_image">';
            searchtext += '<div class="list_text"> <p>';
            searchtext += data[i]['Last Name'] + ', ' + data[i]['First Name'] + "</p><p>";
            searchtext += data[i]['Date of Birth'] +', '+data[i]['Date of Death'] +'</p></div>';
            searchlist.push(searchtext);
        }
        
        //assigning the values to the markers
        for (let i = 0; i < coorlist.length; i++) {
            markerlist.push(L.marker(coorlist[i], {icon: myIcon, draggable: true}));
            markerlist[i].bindPopup(textlist[i]).openPopup().addTo(markersLayer);
        }

        //Code to let us align the markers with the actual graves
        markerlist.forEach(function(marker) {
            marker.on('dragend', function() {
                console.log(marker.getLatLng().toString());
            });
        });
        
        //Making the list
        for (let i = 0; i < searchlist.length; i++) {
            const li = document.createElement('li');
            li.innerHTML = searchlist[i];
            li.style.border = '1px solid #000';
            li.addEventListener('click', function() {
                map.setView(coorlist[i], 20);
                markerlist[i].openPopup();
            });
            listItems.appendChild(li);
        }
        

    }

    document.addEventListener('DOMContentLoaded', function () {
        
        fetch('./CemetaryList.csv')//Getting cav values
            .then(response => response.text())
            .then(contents => {
                //Parse it into an array
                csvLines = Papa.parse(contents, {
                        header: true
                }).data;
                markersLayer = new L.LayerGroup().addTo(map);
                addMarkers(csvLines);
            })
            .catch(error => console.error('Error fetching the file:', error));
    
        
        document.getElementById('searchInput').addEventListener('input', function () {
            var searchTerm = this.value.toLowerCase();
            markersLayer.clearLayers(); // Clear existing markers
            listItems.innerHTML = ''; //Clear out the search bar
            var filteredMarkers = csvLines.filter(function (data) {
                return data['First Name'].toLowerCase().includes(searchTerm) ||
                       data['Last Name' ].toLowerCase().includes(searchTerm);
            });

            addMarkers(filteredMarkers);
        });

        

    });



    
    

    
    //google satellite
    googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        maxZoom: 22, 
        //minZoom: 17, //Commented out for bugfixing
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
    });
    googleSat.addTo(map)

    var wms = L.tileLayer.wms("http://localhost:8080/geoserver/wms", {
        layers: 'geoapp:admin',
        format: 'image/png',
        transparent: true,
        attribution: "wms test",
        maxNativeZoom:19,
        maxZoom:22
    });







   
</script>
